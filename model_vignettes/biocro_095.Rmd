---
title: "Introduction to BioCro Model"
author: "Kristina Riemer"
output: pdf_document
---

## Purpose of model

Simulate growth and photosynthesis of plants using weather and plant traits. 

## Installing package

Run below to install the current stable release of BioCro. 

```{r, eval=FALSE}
devtools::install_github('ebimodeling/biocro')
```

Read in the library. 

```{r}
library(BioCro)
```

## Estimating biomass for growing season

The function `BioGro` is used for this. The only required input is a year of hourly weather data. Here we're using such weather data from a site in Illinois. 

This returns a list where each element is a variable resulting from the model run. This includes biomass values for different parts of the plants and leaf traits such as stomatal conductance and maximum carboxylation rate. 

```{r}
data(cmi04)
head(cmi04)
cmi04_results <- BioGro(cmi04)
names(cmi04_results)
head(cmi04_results$Stem)
```

These results can be visualized using `plot`, which is a modified version of `xyplot` from the `lattice` R package. The default plots the dry biomass of the different plant parts, and other results can be plotted by specifying the `plot.kind`. The cumulative evapotranspiration plot is shown as an example. 

```{r}
plot(cmi04_results)
plot(cmi04_results, plot.kind = "cumET")
```

Many other model parameters can be specified. For example, information about soil properties can be added. The model outputs are plotted for low and high values for the effect of water stress on leaf growth. There is not a built-in way to plot 

```{r}
low_phi <- soilParms(FieldC = 0.37, WiltP = 0.2, phi2 = 1)
high_phi <- soilParms(FieldC = 0.37, WiltP = 0.2, phi2 = 4)

cmi04_results_lowphi <- BioGro(cmi04, soilControl = low_phi)
cmi04_results_highphi <- BioGro(cmi04, soilControl = high_phi)

plot(cmi04_results_lowphi, plot.kind = "SW")
plot(cmi04_results_highphi, plot.kind = "SW")
```

`BioGro` is built on the `c4photo`/`c3photo` and `CanA` functions. Their use is illustrated below. 

## Estimating photosynthesis variables at the leaf level

The function `c4photo` estimates stomatal conductance, net assimilation, intercellular CO~2~, and gross assimilation from photosynthetically active radiation, temperature, and relative humidity. A value for net assimilation is returned below. 

```{r}
photosynthesis_c4 <- c4photo(Qp = 1500, Tl = 25, RH = 0.7)
photosynthesis_c4$Assim
```

This function can take a lot of other parameters, including Vcmax and temperature bounds. The example below shows the difference in output when atmospheric CO~2~ varies. 

```{r}
photosynthesis_c4_lowco2 <- c4photo(Qp = 1250, Tl = 35, RH = 0.7, Catm = 350)
photosynthesis_c4_highco2 <- c4photo(Qp = 1250, Tl = 35, RH = 0.7, Catm = 400)

photosynthesis_c4_lowco2$Assim
photosynthesis_c4_highco2$Assim
```

Observations of net assimilation rate, quantum flux, leaf temperature, and relative humidity can be used to better estimate maximum rate of carboxylation and quantum efficiency to put into `c4photo`/`c3photo`. Example observations from a built-in dataset are shown. 

```{r, message = FALSE}
library(dplyr)
data(aq)
aq_observations <- aq %>% 
  filter(ID == 1) %>% 
  select(A, PARi, Tleaf, RH_S)
aq_observations
```

The function `Opc4photo` takes these observations to produce estimates of Vmax and alpha. 

```{r}
aq_observations_priors <- Opc4photo(aq_observations)
aq_observations_priors$bestVmax
aq_observations_priors$bestAlpha
```

These estimates can also be produced for multiple curves at once (`mOpc4photo`) or with a Bayesian approach (`MCMCc4photo`). 

## Simulate canopy carbon assimilation

Estimates at the canopy-level of carbon assimilation and transpiration are done with the function `CanA`, which is built on `c4photo`. Required inputs include environmental variables, day and time, and leaf area index. 

The number of layers in the canopy can also be specified. While the default is eight layers, an example with more layers is shown. Both carbon assimilation and transpiration outputs are shown. 


```{r}
canopy_fewlayers <- CanA(lai = 3, doy = 200, hr = 12, solar = 1500, temp = 25, 
                         rh = 0.7, windspeed = 2)
canopy_morelayers <- CanA(lai = 3, doy = 200, hr = 12, solar = 1500, temp = 25, 
                          rh = 0.7, windspeed = 2, nlayers = 14)

canopy_fewlayers$CanopyAssim
canopy_morelayers$CanopyAssim

canopy_fewlayers$CanopyTrans
canopy_morelayers$CanopyTrans
```
